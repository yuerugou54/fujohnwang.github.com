<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>How to use SSH in Java Programmatically - 一个架构士的思考与沉</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="王福强的博客， 一个架构士的思考与沉淀">
    <meta name="keywords" content="architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学">
    <meta name="author" content="王福强">
    <link rel="stylesheet" href="/ivy.css">
    <link rel="shortcut icon" href="/favicon.ico"/>
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
    a.sourceLine { display: inline-block; line-height: 1.25; }
    a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
    a.sourceLine:empty { height: 1.2em; position: absolute; }
    .sourceCode { overflow: visible; }
    code.sourceCode { white-space: pre; position: relative; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    code.sourceCode { white-space: pre-wrap; }
    a.sourceLine { text-indent: -1em; padding-left: 1em; }
    }
    pre.numberSource a.sourceLine
      { position: relative; }
    pre.numberSource a.sourceLine:empty
      { position: absolute; }
    pre.numberSource a.sourceLine::before
      { content: attr(data-line-number);
        position: absolute; left: -5em; text-align: right; vertical-align: baseline;
        border: none; pointer-events: all;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  }
    @media screen {
    a.sourceLine::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
            <!-- 百度统计 -->
    <script>
      var _hmt = _hmt || [];
      (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?4b0cf57d9b677da796218f27d72dbbca";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
      })();
    </script>
  </head>

  <body class="node homepage">

    <header class="masthead">
      <h1><a href="/">扶墙老师说</a></h1>
      <p class="tagline">
         一个架构士的思考与沉淀
          <img src="/images/wechat-qrcode-footer.png"/>
          扶墙老师，辨证施“知”
      </p>
      
      <nav class="menu">
        <input id="menu-check" type="checkbox"/>
        <label id="menu-label" for="menu-check" class="unselectable">
          <span class="icon close-icon">✕</span>
          <span class="icon open-icon">☰</span>
          <span class="text">展开</span>
        </label>
        <ul>
            <li class="nav-item"><a class="nav-link" href="/favorite.html">我的收藏</a></li>
            <li class="nav-item"><a class="nav-link" href="/dashboard.html">金融看板</a></li>
            <li class="nav-item"><a class="nav-link" href="/columns.html">专栏文章</a></li>
            <li class="nav-item"><a class="nav-link" href="/references.html">快捷参考</a></li>
            <li class="nav-item"><a class="nav-link" href="/whoami.html">我是何人</a></li>
            <li class="nav-item"><a class="nav-link" href="/interlinks.html">友情链接</a></li>
            <li class="nav-item"><a class="nav-link" href="/feeds.xml">RSS订阅</a></li>
        </ul>
      </nav>
    </header>

    <article class="main">
      
<div class="row">
<div id="header">
<p class="lead">
<h1 class="title">How to use SSH in Java Programmatically</h1>
<small>
<h3 class="author">FuqiangWang</h3>
</small>
</p>
</div>

<hr>


<blockquote>
<p>2014年从msn space存档中重新恢复出来！</p>
</blockquote>
<p>在Java程序中使用SSH（How to use SSH in Java Programmatically)</p>
<p>—by Darren.Wang</p>
<p>这个标题不知道能不能表达我的意思，实际上我只是想总结一下可以通过哪些方式或者途径来达到在Java程序中使用SSH相关功能（任务）的目的。前几天有更多free time，所以，为了简化credit的管理工具正式版的发布上传过程，简单实现了一个基于SWT界面的上传应用程序，要完成的功能其实也很简单，但是为了提高上传速度和数据传输的安全性，所以，上传分成几个阶段同时使用SSH来保证上传过程的安全性，之于说上传的阶段等细节不属于我今天要描述的重点，重点是如何在Java中使用SSH，尤其是远程登录到Linux，并执行Shell命令。</p>
<p>现从同事的一个需求说起，他手头的任务中包括检查某台Linux机器的磁盘空间等情况，并随同Email发送。当然别人也给他提出了多种解决方法，不能说不好，但在我看了与程序的集成性上面差一些，所以我觉得给他写一个Utility（坐我旁边，不帮都不行，呵呵）。</p>
<p>实际上，实现原理很简单，直接SSH登录那台Linux机器执行df命令就可以了，其他信息，像当前目录拥有的文件列表等，运行ls -ls命令，这些我想大家都很清楚，那么在Java中我们是如何实现类似功能的那？！</p>
<p>可能有人以前做过类似功能，那他一定听说过JSch或者说OpenSSH（当然，我们会用他的Java实现安ganymed），对，我们也只是为JSch提供了一个简单的Wrapper而已。</p>
<p>先来看看这个Wrapper是什么样子的吧，然后我再详细说一下这个程序的设计和实现细节：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">package</span><span class="im"> org.darrenstudio.ssh;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">import</span><span class="im"> java.io.InputStream;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">import</span><span class="im"> java.util.Properties;</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">import</span><span class="im"> org.apache.commons.lang.Validate;</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">import</span><span class="im"> org.darrenstudio.ssh.callback.SSHExecCallback;</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">import</span><span class="im"> com.jcraft.jsch.Channel;</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw">import</span><span class="im"> com.jcraft.jsch.ChannelExec;</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">import</span><span class="im"> com.jcraft.jsch.JSch;</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="kw">import</span><span class="im"> com.jcraft.jsch.Session;</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw">public</span> <span class="kw">class</span> SSHExecutor {</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw">private</span> JSch jsch;</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">private</span> Session session;</a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="kw">private</span> <span class="dt">boolean</span> login;</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">login</span>(SSHLoginOptions options) <span class="kw">throws</span> SSHExecException</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">{</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="kw">try</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="kw">if</span>(jsch == <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">jsch =<span class="kw">new</span> <span class="fu">JSch</span>();</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">session = jsch.<span class="fu">getSession</span>(options.<span class="fu">getUsername</span>(),options.<span class="fu">getHost</span>(),options.<span class="fu">getPort</span>());</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">session.<span class="fu">setPassword</span>(options.<span class="fu">getPassword</span>());</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="bu">Properties</span> prop = <span class="kw">new</span> <span class="bu">Properties</span>();</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">prop.<span class="fu">setProperty</span>(<span class="st">&quot;StrictHostKeyChecking&quot;</span>,<span class="st">&quot;no&quot;</span>);<span class="co">//StrictHostKeyChecking: ask | yes | no</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29">session.<span class="fu">setConfig</span>(prop);</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">session.<span class="fu">connect</span>();</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">login = <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="kw">catch</span>(<span class="bu">Exception</span> e)</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">{</a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(e);</a>
<a class="sourceLine" id="cb1-36" data-line-number="36">}</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">}</a>
<a class="sourceLine" id="cb1-38" data-line-number="38"></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">execute</span>(<span class="bu">String</span> command,SSHExecCallback callback) <span class="kw">throws</span> SSHExecException</a>
<a class="sourceLine" id="cb1-40" data-line-number="40">{</a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="kw">if</span>(!login)</a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(<span class="st">&quot;login first before executing the remote command!&quot;</span>);</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">Validate.<span class="fu">notEmpty</span>(command);</a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="bu">Channel</span> channel = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb1-45" data-line-number="45"><span class="kw">try</span></a>
<a class="sourceLine" id="cb1-46" data-line-number="46">{</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">channel =session.<span class="fu">openChannel</span>(<span class="st">&quot;exec&quot;</span>);</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">((ChannelExec)channel).<span class="fu">setCommand</span>(command);</a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="bu">InputStream</span> in=channel.<span class="fu">getInputStream</span>();</a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="co">// OutputStream out=channel.getOutputStream();</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51"><span class="bu">InputStream</span> err = ((ChannelExec)channel).<span class="fu">getErrStream</span>();</a>
<a class="sourceLine" id="cb1-52" data-line-number="52"></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="co">// to retrieve the interactive password request information, this pty is a must</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54">((ChannelExec)channel).<span class="fu">setPty</span>(<span class="kw">true</span>);</a>
<a class="sourceLine" id="cb1-55" data-line-number="55"></a>
<a class="sourceLine" id="cb1-56" data-line-number="56">channel.<span class="fu">connect</span>();</a>
<a class="sourceLine" id="cb1-57" data-line-number="57"></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="dt">byte</span>[] tmp=<span class="kw">new</span> <span class="dt">byte</span>[<span class="dv">2048</span>];</a>
<a class="sourceLine" id="cb1-59" data-line-number="59"><span class="kw">while</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb1-60" data-line-number="60">{</a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="kw">while</span>(in.<span class="fu">available</span>() &gt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-62" data-line-number="62">{</a>
<a class="sourceLine" id="cb1-63" data-line-number="63"><span class="dt">int</span> i=in.<span class="fu">read</span>(tmp, <span class="dv">0</span>, <span class="dv">2048</span>);</a>
<a class="sourceLine" id="cb1-64" data-line-number="64"><span class="bu">String</span> line = <span class="kw">new</span> <span class="bu">String</span>(tmp, <span class="dv">0</span>, i);</a>
<a class="sourceLine" id="cb1-65" data-line-number="65">callback.<span class="fu">dumpConsole</span>(line);</a>
<a class="sourceLine" id="cb1-66" data-line-number="66">}</a>
<a class="sourceLine" id="cb1-67" data-line-number="67"></a>
<a class="sourceLine" id="cb1-68" data-line-number="68"><span class="kw">while</span>(err.<span class="fu">available</span>() &gt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-69" data-line-number="69">{</a>
<a class="sourceLine" id="cb1-70" data-line-number="70"><span class="dt">int</span> size = err.<span class="fu">read</span>(tmp,<span class="dv">0</span>,<span class="dv">2048</span>);</a>
<a class="sourceLine" id="cb1-71" data-line-number="71"><span class="bu">String</span> line = <span class="kw">new</span> <span class="bu">String</span>(tmp,<span class="dv">0</span>,size);</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">callback.<span class="fu">dumpErrStream</span>(line);</a>
<a class="sourceLine" id="cb1-73" data-line-number="73">}</a>
<a class="sourceLine" id="cb1-74" data-line-number="74"></a>
<a class="sourceLine" id="cb1-75" data-line-number="75"><span class="kw">if</span>(channel.<span class="fu">isClosed</span>())</a>
<a class="sourceLine" id="cb1-76" data-line-number="76">{</a>
<a class="sourceLine" id="cb1-77" data-line-number="77"><span class="dt">int</span> exitStatus = channel.<span class="fu">getExitStatus</span>();</a>
<a class="sourceLine" id="cb1-78" data-line-number="78"><span class="kw">if</span>(exitStatus != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-79" data-line-number="79"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(<span class="st">&quot;Error Exit Status with Value:&quot;</span>+exitStatus);</a>
<a class="sourceLine" id="cb1-80" data-line-number="80"><span class="kw">break</span>;</a>
<a class="sourceLine" id="cb1-81" data-line-number="81">}</a>
<a class="sourceLine" id="cb1-82" data-line-number="82"><span class="kw">try</span>{<span class="bu">Thread</span>.<span class="fu">sleep</span>(<span class="dv">1000</span>);}<span class="kw">catch</span>(<span class="bu">Exception</span> ee){}</a>
<a class="sourceLine" id="cb1-83" data-line-number="83">}</a>
<a class="sourceLine" id="cb1-84" data-line-number="84">}</a>
<a class="sourceLine" id="cb1-85" data-line-number="85"><span class="kw">catch</span>(<span class="bu">Exception</span> e)</a>
<a class="sourceLine" id="cb1-86" data-line-number="86">{</a>
<a class="sourceLine" id="cb1-87" data-line-number="87"><span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(e);</a>
<a class="sourceLine" id="cb1-88" data-line-number="88">}</a>
<a class="sourceLine" id="cb1-89" data-line-number="89"><span class="kw">finally</span></a>
<a class="sourceLine" id="cb1-90" data-line-number="90">{</a>
<a class="sourceLine" id="cb1-91" data-line-number="91"><span class="kw">if</span>(channel != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb1-92" data-line-number="92">{</a>
<a class="sourceLine" id="cb1-93" data-line-number="93">channel.<span class="fu">disconnect</span>();</a>
<a class="sourceLine" id="cb1-94" data-line-number="94">channel = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb1-95" data-line-number="95">}</a>
<a class="sourceLine" id="cb1-96" data-line-number="96">}</a>
<a class="sourceLine" id="cb1-97" data-line-number="97"></a>
<a class="sourceLine" id="cb1-98" data-line-number="98">}</a>
<a class="sourceLine" id="cb1-99" data-line-number="99"></a>
<a class="sourceLine" id="cb1-100" data-line-number="100"><span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">dispose</span>()</a>
<a class="sourceLine" id="cb1-101" data-line-number="101">{</a>
<a class="sourceLine" id="cb1-102" data-line-number="102"><span class="kw">if</span>(session != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb1-103" data-line-number="103">{</a>
<a class="sourceLine" id="cb1-104" data-line-number="104">session.<span class="fu">disconnect</span>();</a>
<a class="sourceLine" id="cb1-105" data-line-number="105">session = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb1-106" data-line-number="106">}</a>
<a class="sourceLine" id="cb1-107" data-line-number="107">login = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb1-108" data-line-number="108">}</a>
<a class="sourceLine" id="cb1-109" data-line-number="109">}</a></code></pre></div>
<p>我们给出一个Executor，他负责为我们执行Shell命令，他首先要求我们登录到要执行命令的Linux机器（即login方法），然后，如果登录成功，client端就可以调用execute方法来执行相应的shell命令，执行后，在finally中dispose掉该Executor。</p>
<p>对于login方法来说，因为需要提供login相关信息，而且这些信息参数较多，3－4个，当然，相对来说也不是很多，但是，我们还是采用将他们归并到一个参数类的做法（我想Effective Java大家都读过），这就有了我们的SSHLoginOptions类：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> SSHLoginOptions <span class="kw">implements</span> <span class="bu">Serializable</span> {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID = -8018206086412607771L;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">private</span> <span class="bu">String</span> host;</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">private</span> <span class="bu">String</span> username;</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">private</span> <span class="bu">String</span> password;</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">private</span> <span class="dt">int</span> port = <span class="dv">22</span>;</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">public</span> <span class="fu">SSHLoginOptions</span>(<span class="bu">String</span> host,<span class="bu">String</span> username,<span class="bu">String</span> password)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">{</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="kw">this</span>(host,username,password,<span class="dv">22</span>);</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="kw">public</span> <span class="fu">SSHLoginOptions</span>(<span class="bu">String</span> host,<span class="bu">String</span> username,<span class="bu">String</span> password,<span class="dt">int</span> port)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">{</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="kw">this</span>.<span class="fu">host</span> = host;</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">this</span>.<span class="fu">username</span> = username;</a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="kw">this</span>.<span class="fu">password</span> = password;</a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="kw">this</span>.<span class="fu">port</span> = port;</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="kw">public</span> <span class="bu">String</span> <span class="fu">getHost</span>() {</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="kw">return</span> host;</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">}</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setHost</span>(<span class="bu">String</span> host) {</a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="kw">this</span>.<span class="fu">host</span> = host;</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb2-29" data-line-number="29"></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="kw">public</span> <span class="bu">String</span> <span class="fu">getPassword</span>() {</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="kw">return</span> password;</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setPassword</span>(<span class="bu">String</span> password) {</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="kw">this</span>.<span class="fu">password</span> = password;</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">}</a>
<a class="sourceLine" id="cb2-37" data-line-number="37"></a>
<a class="sourceLine" id="cb2-38" data-line-number="38"><span class="kw">public</span> <span class="dt">int</span> <span class="fu">getPort</span>() {</a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="kw">return</span> port;</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb2-41" data-line-number="41"></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setPort</span>(<span class="dt">int</span> port) {</a>
<a class="sourceLine" id="cb2-43" data-line-number="43"><span class="kw">this</span>.<span class="fu">port</span> = port;</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">}</a>
<a class="sourceLine" id="cb2-45" data-line-number="45"></a>
<a class="sourceLine" id="cb2-46" data-line-number="46"><span class="kw">public</span> <span class="bu">String</span> <span class="fu">getUsername</span>() {</a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="kw">return</span> username;</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb2-49" data-line-number="49"></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUsername</span>(<span class="bu">String</span> username) {</a>
<a class="sourceLine" id="cb2-51" data-line-number="51"><span class="kw">this</span>.<span class="fu">username</span> = username;</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">}</a>
<a class="sourceLine" id="cb2-53" data-line-number="53"></a>
<a class="sourceLine" id="cb2-54" data-line-number="54"><span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span>() {</a>
<a class="sourceLine" id="cb2-55" data-line-number="55"><span class="kw">return</span> <span class="kw">new</span> <span class="fu">ToStringBuilder</span>(<span class="kw">this</span>).<span class="fu">append</span>(<span class="st">&quot;host&quot;</span>, host).<span class="fu">append</span>(</a>
<a class="sourceLine" id="cb2-56" data-line-number="56"><span class="st">&quot;username&quot;</span>, username).<span class="fu">append</span>(<span class="st">&quot;password&quot;</span>, password).<span class="fu">append</span>(</a>
<a class="sourceLine" id="cb2-57" data-line-number="57"><span class="st">&quot;port&quot;</span>, port).<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb2-58" data-line-number="58">}</a>
<a class="sourceLine" id="cb2-59" data-line-number="59">}</a></code></pre></div>
<p>如果登录不成功的话(可能因为网络不通等原因），我们需要抛出一个异常以便告诉Client端该事件，并终止以下步骤，所以，我们采用抛出自定义的SSHExecException：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> SSHExecException <span class="kw">extends</span> NestableException {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID = -2804917566444475128L;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">public</span> <span class="fu">SSHExecException</span>(<span class="bu">String</span> cause)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">{</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">super</span>(cause);</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">public</span> <span class="fu">SSHExecException</span>(<span class="bu">Throwable</span> t)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">super</span>(t);</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">public</span> <span class="fu">SSHExecException</span>(<span class="bu">String</span> cause,<span class="bu">Throwable</span> t)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">{</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw">super</span>(cause,t);</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">}</a></code></pre></div>
<p>（这里定义为一个Checked异常，实际上，感觉定义为unchecked异常更恰当一些，因为如果失败，Client端也做不了什么）</p>
<p>登录成功后，login标志被置为true，这样execute方法才可以被调用。</p>
<p>execute方法有两个参数，第一个参数为String类型，表示将被执行Shell命令；第二个参数较为特殊，他是我们自己定义的一个接口：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">public</span> <span class="kw">interface</span> SSHExecCallback {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="dt">void</span> <span class="fu">dumpConsole</span>(<span class="bu">String</span> line);</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="dt">void</span> <span class="fu">dumpErrStream</span>(<span class="bu">String</span> errline);</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a></code></pre></div>
<p>这个接口的实现负责处理Linux的正常输出和Error输出，至于说如何处理这些输出，你可以按照自己的需要给出自己的实现，比如，只是简单的打印到控制台：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> DefaultSSHExecCallback <span class="kw">implements</span> SSHExecCallback {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">dumpConsole</span>(<span class="bu">String</span> line) {</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(line);</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    }</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">dumpErrStream</span>(<span class="bu">String</span> errline) {</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    <span class="bu">System</span>.<span class="fu">err</span>.<span class="fu">println</span>(errline);</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    }</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">｝</a></code></pre></div>
<p>在execute方法一开始，我们会检查是否登录成功，如果没有，那同样会抛出SSHExecException，以示说该类没有为Shell命令的执行准备好相应的状态，从而阻止随后的不安全操作。 之后，我们会打开一个Exec Channel，通过这个Channel来执行Shell命令，这可以很容易的从Executor的源码中看出来，如果执行过程中出现异常，我们会抛给Client端我们的自定义异常，当然，不管执行成功或者失败与否，我们都会关掉该Channel以释放连接，否则，主程序会挂在那里。在execute方法中，唯一需要关注的一个地方就是((ChannelExec)channel).setPty(true);这一句，如果没有他，那你的控制台将什么东西都没有，你将得不到任何想要的信息。</p>
<p>为了说命令执行完成后释放资源，我们给出一个dispose方法，这也是很自然的，这里不再赘述。</p>
<p>下面是该类的一个TestCase，大家可以很容易看出该类的使用，很简单。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> SSHExecutorTest <span class="kw">extends</span> TestCase {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="kw">private</span> SSHExecutor executor;</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    junit.<span class="fu">textui</span>.<span class="fu">TestRunner</span>.<span class="fu">run</span>(SSHExecutorTest.<span class="fu">class</span>);</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">setUp</span>() <span class="kw">throws</span> <span class="bu">Exception</span> {</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    <span class="kw">super</span>.<span class="fu">setUp</span>();</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    executor = <span class="kw">new</span> <span class="fu">SSHExecutor</span>();</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    SSHLoginOptions loginOptions = <span class="kw">new</span> <span class="fu">SSHLoginOptions</span>(<span class="st">&quot;m.livedoor.cn&quot;</span>,<span class="st">&quot;root&quot;</span>,<span class="st">&quot;zxcv1234&quot;</span>);</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    executor.<span class="fu">login</span>(loginOptions);</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    }</a>
<a class="sourceLine" id="cb6-15" data-line-number="15"></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">tearDown</span>() <span class="kw">throws</span> <span class="bu">Exception</span> {</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="kw">super</span>.<span class="fu">tearDown</span>();</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    executor.<span class="fu">dispose</span>();</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">    executor = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    }</a>
<a class="sourceLine" id="cb6-21" data-line-number="21"></a>
<a class="sourceLine" id="cb6-22" data-line-number="22">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testExecuteWithCommandUname</span>() <span class="kw">throws</span> SSHExecException</a>
<a class="sourceLine" id="cb6-23" data-line-number="23">    {</a>
<a class="sourceLine" id="cb6-24" data-line-number="24">    <span class="bu">String</span> command = <span class="st">&quot;uname&quot;</span>;</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">    GenericSSHExecCallback callback = <span class="kw">new</span> <span class="fu">GenericSSHExecCallback</span>();</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">    executor.<span class="fu">execute</span>(command,callback);</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">    <span class="fu">assertEquals</span>(<span class="st">&quot;The Operating System of m.livedoor.cn should be Linux&quot;</span>,<span class="st">&quot;Linux&quot;</span>,StringUtils.<span class="fu">trimToEmpty</span>(callback.<span class="fu">getOutput</span>()));</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    }</a>
<a class="sourceLine" id="cb6-29" data-line-number="29">}</a></code></pre></div>
<p>至此，我们的Wrapper类就算完成了，让我们回过头来看看，我们能归纳出什么东西。</p>
<p>到目前为止，我所可以提供的相关信息有两类，一类就是执行Scp相关操作，一类就是基于SSH的Shell命令的执行，那么要完成这两类功能，现在有什么东西可以让我们避免去重新发明轮子那？！</p>
<p>对于Scp相关任务来说，除了前面blog曾经提到过的通过Ant来实现外，你也可以通过JSch来完成，不要忘了，Ant的Scp Task也是通过JSch完成的，除此之外，OpenSSH的Java实现—ganymed也可以很容易的实现scp功能，而且，代码也看起来很简洁：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">* </span><span class="kw">@author </span>darrenwang</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">*</span> <span class="kw">@since </span><span class="co">1.0</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">public</span> <span class="kw">class</span> SCPExecutor {</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    <span class="kw">private</span> <span class="bu">Connection</span> connection;</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="kw">private</span> <span class="dt">boolean</span> login;</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">login</span>(SSHLoginOptions options) <span class="kw">throws</span> SSHExecException</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    {</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">        <span class="kw">try</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        {</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">            connection = <span class="kw">new</span> <span class="bu">Connection</span>(options.<span class="fu">getHost</span>());</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">            connection.<span class="fu">connect</span>();</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">            login = connection.<span class="fu">authenticateWithPassword</span>(options.<span class="fu">getUsername</span>(),options.<span class="fu">getPassword</span>());</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">            <span class="kw">if</span>(!login)</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(<span class="st">&quot;Authentication failed.&quot;</span>);</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        }</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">        <span class="kw">catch</span>(<span class="bu">Exception</span> e)</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">        {</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(e);</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">        }</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">    }</a>
<a class="sourceLine" id="cb7-24" data-line-number="24"></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">doScp</span>(<span class="bu">File</span> file, <span class="bu">String</span> todir) <span class="kw">throws</span> SSHExecException</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">    {</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">        <span class="kw">if</span>(!login)</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(<span class="st">&quot;login() first before executing the scp task!&quot;</span>);</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">        <span class="kw">try</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">        {</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">            SCPClient client = connection.<span class="fu">createSCPClient</span>();</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">            client.<span class="fu">put</span>(file.<span class="fu">getAbsolutePath</span>(),todir);</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">        }</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">        <span class="kw">catch</span>(<span class="bu">Exception</span> e)</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">        {</a>
<a class="sourceLine" id="cb7-36" data-line-number="36">            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">SSHExecException</span>(e);</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">        }</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">    }</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">dispose</span>()</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">    {</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">        <span class="kw">if</span>(connection != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">        {</a>
<a class="sourceLine" id="cb7-43" data-line-number="43">            connection.<span class="fu">close</span>();</a>
<a class="sourceLine" id="cb7-44" data-line-number="44">            connection = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb7-45" data-line-number="45">        }</a>
<a class="sourceLine" id="cb7-46" data-line-number="46">        login = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">    }</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">}</a></code></pre></div>
<p>除了Scp，那剩下很大一部分任务可能都是基于SSH的Shell命令执行啦，这个同样，你可以通过Ant，JSch和ganymed来实现，这里就不做赘述了，因为通过上面的SSHExecutor和以前的blog，你可以很容易的给出实现。</p>
<p>OK，今天就写这些了，《地海传说》，我来啦…</p>

    </article>

  </body>
</html>
