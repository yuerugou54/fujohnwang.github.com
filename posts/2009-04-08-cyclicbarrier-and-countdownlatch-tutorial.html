<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>我爱J普 之 CyclicBarrier And CountDownLatch Tutorial - 一个架构士的思考与沉</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="王福强的博客， 一个架构士的思考与沉淀">
    <meta name="keywords" content="architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学">
    <meta name="author" content="王福强">
    <link rel="stylesheet" href="/ivy.css">
    <link rel="shortcut icon" href="/favicon.ico"/>
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
    a.sourceLine { display: inline-block; line-height: 1.25; }
    a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
    a.sourceLine:empty { height: 1.2em; position: absolute; }
    .sourceCode { overflow: visible; }
    code.sourceCode { white-space: pre; position: relative; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    code.sourceCode { white-space: pre-wrap; }
    a.sourceLine { text-indent: -1em; padding-left: 1em; }
    }
    pre.numberSource a.sourceLine
      { position: relative; }
    pre.numberSource a.sourceLine:empty
      { position: absolute; }
    pre.numberSource a.sourceLine::before
      { content: attr(data-line-number);
        position: absolute; left: -5em; text-align: right; vertical-align: baseline;
        border: none; pointer-events: all;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  }
    @media screen {
    a.sourceLine::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
            <!-- 百度统计 -->
    <script>
      var _hmt = _hmt || [];
      (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?4b0cf57d9b677da796218f27d72dbbca";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
      })();
    </script>
  </head>

  <body class="node homepage">

    <header class="masthead">
      <h1><a href="/">扶墙老师说</a></h1>
      <p class="tagline">
         一个架构士的思考与沉淀
          <img src="/images/wechat-qrcode-footer.png"/>
          扶墙老师，辨证施“知”
      </p>
      
      <nav class="menu">
        <input id="menu-check" type="checkbox"/>
        <label id="menu-label" for="menu-check" class="unselectable">
          <span class="icon close-icon">✕</span>
          <span class="icon open-icon">☰</span>
          <span class="text">展开</span>
        </label>
        <ul>
          <li class="nav-item"><a class="nav-link" href="https://www.keevol.com">福强科技</a></li>
            <li class="nav-item"><a class="nav-link" href="/favorite.html">我的收藏</a></li>
            <li class="nav-item"><a class="nav-link" href="/dashboard.html">金融看板</a></li>
            <li class="nav-item"><a class="nav-link" href="/columns.html">专栏文章</a></li>
            <li class="nav-item"><a class="nav-link" href="/references.html">快捷参考</a></li>
            <li class="nav-item"><a class="nav-link" href="/whoami.html">我是何人</a></li>
            <li class="nav-item"><a class="nav-link" href="/interlinks.html">友情链接</a></li>
            <li class="nav-item"><a class="nav-link" href="/feeds.xml">RSS订阅</a></li>
        </ul>
      </nav>
    </header>

    <article class="main">
      
<div class="row">
<div id="header">
<p class="lead">
<h1 class="title">我爱J普 之 CyclicBarrier And CountDownLatch Tutorial</h1>
</p>
</div>

<hr>

<div id="TOC">
<ul>
<li><a href="#cyclicbarrier-first"><span class="toc-section-number">1</span> CyclicBarrier First</a></li>
<li><a href="#countdownlatch切这有啥我也行"><span class="toc-section-number">2</span> CountDownLatch:切，这有啥，我也行！</a></li>
<li><a href="#最后要说的话"><span class="toc-section-number">3</span> 最后要说的话</a></li>
</ul>
</div>
<hr/>

<p>说实在的，我其实是看别人的代码看得郁闷了，所以，写点儿东西舒缓一下，在农村看下象棋的时候，有那么一句话，叫做“跟臭棋娄子下棋，越下越臭”， 而我真的不想那样，只能自己时刻的keep alert，其实吧，你可能觉得我是太清高，好像就你写的代码好似的，不过那，先给各位看官罗列点儿“小菜”尝尝先：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">while</span>(<span class="kw">true</span>){</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">    ;</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">// ---------------------------</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="at">@Override</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">finalize</span>() <span class="kw">throws</span> <span class="bu">Throwable</span> {</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    something.<span class="fu">destroy</span>();</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="co">// or</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    something.<span class="fu">close</span>();</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">}</a></code></pre></div>
<p>这些属于比较恶劣的情况，写今天这个主题那，是因为时至今日，还是看到了Thread.wait(), notify(), join()之类的直接底层API的使用，所以， 做回好人，也算是帮大家和我自己开拓思想吧（虽然都tmd不是很新了）！</p>
<p>先假设（对，不假设不知道下面东西怎么开始说），我们有这么一批Task，姑且叫Batch Task和RealTime Task，这批Task的执行有个简单的前提，就是只有当所有Batch Task执行完毕之后， RealTime Task才可以执行，为了实现这个要求，我们那一般来说，有两个选择，也就是我们标题上的那两个东西。</p>
<h1 id="cyclicbarrier-first"><span class="header-section-number">1</span> CyclicBarrier First</h1>
<p>CyclicBarrier就像个栅栏（好像是废话，人家名字就说明问题了嘛），它将拦截规定数目的线程执行，正常情况下， 只有当所有线程都完成工作到达这个栅栏之后，CyclicBarrier才会放行，让后面的逻辑得以执行。 简单点儿说，其实这东西挺适合解决我们刚才假设的问题场景的。</p>
<p>首先介绍最简单的“选手”，我们的BatchTask和RealtimeTask：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BatchTask <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">        <span class="co">// TODO your batch task logic</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    }</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">public</span> <span class="kw">class</span> RealtimeTask <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">        <span class="co">// TODO your real-time task logic</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">}</a></code></pre></div>
<p>简单的不能再简单了，呵呵，别骂我哈，为啥这么简单，待会儿再说。 接下来是针对我们的假设所给出的使用CyclicBarrier的解决方案：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CyclicBarrierTaskScheduler <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="kw">private</span> <span class="bu">CyclicBarrier</span> cyclicBarrier;</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    <span class="kw">private</span> <span class="dt">int</span>           batchTaskNumbers;</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="kw">private</span> <span class="dt">int</span>           realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="co">// you can set an ExecutorService extenally</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="kw">private</span> <span class="bu">ExecutorService</span> executor = <span class="bu">Executors</span>.<span class="fu">newFixedThreadPool</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">        <span class="co">// pre-validate on states of current object</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12">        </a>
<a class="sourceLine" id="cb3-13" data-line-number="13">        cyclicBarrier = <span class="kw">new</span> <span class="bu">CyclicBarrier</span>(<span class="fu">getBatchTaskNumbers</span>(), <span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getRealtimeTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                {</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                    <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="fu">RealtimeTask</span>());</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                }</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">            }});</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">        </a>
<a class="sourceLine" id="cb3-21" data-line-number="21">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getBatchTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">        {</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">                    <span class="kw">new</span> <span class="fu">BatchTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">                    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">                        <span class="fu">getCyclicBarrier</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">                    } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">                        e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                    } <span class="kw">catch</span> (<span class="bu">BrokenBarrierException</span> e) {</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">                        e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32">                    }</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">                }});</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">        }</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">        </a>
<a class="sourceLine" id="cb3-36" data-line-number="36">    }</a>
<a class="sourceLine" id="cb3-37" data-line-number="37">    </a>
<a class="sourceLine" id="cb3-38" data-line-number="38">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">shutdown</span>()</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">    {</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">        <span class="kw">if</span>(<span class="fu">getExecutor</span>() != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">        {</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">            <span class="fu">getExecutor</span>().<span class="fu">shutdown</span>();</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">            <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">                <span class="fu">getExecutor</span>().<span class="fu">awaitTermination</span>(<span class="bu">Integer</span>.<span class="fu">MAX_VALUE</span>, <span class="bu">TimeUnit</span>.<span class="fu">SECONDS</span>);</a>
<a class="sourceLine" id="cb3-45" data-line-number="45">            } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb3-46" data-line-number="46">                e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb3-47" data-line-number="47">            }</a>
<a class="sourceLine" id="cb3-48" data-line-number="48">        }</a>
<a class="sourceLine" id="cb3-49" data-line-number="49">    }</a>
<a class="sourceLine" id="cb3-50" data-line-number="50"></a>
<a class="sourceLine" id="cb3-51" data-line-number="51">    <span class="kw">public</span> <span class="bu">CyclicBarrier</span> <span class="fu">getCyclicBarrier</span>() {</a>
<a class="sourceLine" id="cb3-52" data-line-number="52">        <span class="kw">return</span> cyclicBarrier;</a>
<a class="sourceLine" id="cb3-53" data-line-number="53">    }</a>
<a class="sourceLine" id="cb3-54" data-line-number="54"></a>
<a class="sourceLine" id="cb3-55" data-line-number="55">    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getBatchTaskNumbers</span>() {</a>
<a class="sourceLine" id="cb3-56" data-line-number="56">        <span class="kw">return</span> batchTaskNumbers;</a>
<a class="sourceLine" id="cb3-57" data-line-number="57">    }</a>
<a class="sourceLine" id="cb3-58" data-line-number="58"></a>
<a class="sourceLine" id="cb3-59" data-line-number="59">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setBatchTaskNumbers</span>(<span class="dt">int</span> batchTaskNumbers) {</a>
<a class="sourceLine" id="cb3-60" data-line-number="60">        <span class="kw">this</span>.<span class="fu">batchTaskNumbers</span> = batchTaskNumbers;</a>
<a class="sourceLine" id="cb3-61" data-line-number="61">    }</a>
<a class="sourceLine" id="cb3-62" data-line-number="62"></a>
<a class="sourceLine" id="cb3-63" data-line-number="63">    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getRealtimeTaskNumbers</span>() {</a>
<a class="sourceLine" id="cb3-64" data-line-number="64">        <span class="kw">return</span> realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb3-65" data-line-number="65">    }</a>
<a class="sourceLine" id="cb3-66" data-line-number="66"></a>
<a class="sourceLine" id="cb3-67" data-line-number="67">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setRealtimeTaskNumbers</span>(<span class="dt">int</span> realtimeTaskNumbers) {</a>
<a class="sourceLine" id="cb3-68" data-line-number="68">        <span class="kw">this</span>.<span class="fu">realtimeTaskNumbers</span> = realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb3-69" data-line-number="69">    }</a>
<a class="sourceLine" id="cb3-70" data-line-number="70"></a>
<a class="sourceLine" id="cb3-71" data-line-number="71">    <span class="kw">public</span> <span class="bu">ExecutorService</span> <span class="fu">getExecutor</span>() {</a>
<a class="sourceLine" id="cb3-72" data-line-number="72">        <span class="kw">return</span> executor;</a>
<a class="sourceLine" id="cb3-73" data-line-number="73">    }</a>
<a class="sourceLine" id="cb3-74" data-line-number="74"></a>
<a class="sourceLine" id="cb3-75" data-line-number="75">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setExecutor</span>(<span class="bu">ExecutorService</span> executor) {</a>
<a class="sourceLine" id="cb3-76" data-line-number="76">        <span class="kw">this</span>.<span class="fu">executor</span> = executor;</a>
<a class="sourceLine" id="cb3-77" data-line-number="77">    }</a>
<a class="sourceLine" id="cb3-78" data-line-number="78">    </a>
<a class="sourceLine" id="cb3-79" data-line-number="79">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args)</a>
<a class="sourceLine" id="cb3-80" data-line-number="80">    {</a>
<a class="sourceLine" id="cb3-81" data-line-number="81">        CyclicBarrierTaskScheduler taskScheduler = <span class="kw">new</span> <span class="fu">CyclicBarrierTaskScheduler</span>();</a>
<a class="sourceLine" id="cb3-82" data-line-number="82">        taskScheduler.<span class="fu">setBatchTaskNumbers</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb3-83" data-line-number="83">        taskScheduler.<span class="fu">setRealtimeTaskNumbers</span>(<span class="dv">15</span>);</a>
<a class="sourceLine" id="cb3-84" data-line-number="84">        </a>
<a class="sourceLine" id="cb3-85" data-line-number="85">        <span class="kw">try</span></a>
<a class="sourceLine" id="cb3-86" data-line-number="86">        {</a>
<a class="sourceLine" id="cb3-87" data-line-number="87">            taskScheduler.<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb3-88" data-line-number="88">        }</a>
<a class="sourceLine" id="cb3-89" data-line-number="89">        <span class="kw">finally</span></a>
<a class="sourceLine" id="cb3-90" data-line-number="90">        {</a>
<a class="sourceLine" id="cb3-91" data-line-number="91">            taskScheduler.<span class="fu">shutdown</span>();</a>
<a class="sourceLine" id="cb3-92" data-line-number="92">        }</a>
<a class="sourceLine" id="cb3-93" data-line-number="93">    }</a>
<a class="sourceLine" id="cb3-94" data-line-number="94">}</a></code></pre></div>
<p>CyclicBarrier一共有两个构造方法（Constructor）, 一个就是我们刚刚使用的: <code>CyclicBarrier(int parties, Runnable barrierAction)</code>, 两个参数：</p>
<ul>
<li>parties是说，我（CyclicBarrier）可以阻挡多少个线程执行，只有当这些数目的线程都到达之后，我（CyclicBarrier）才放行；</li>
<li>barrierAction是当所有的线程成功突破CyclicBarrier的封锁之后执行的Runnable；</li>
</ul>
<p>有了这些信息，回头来看CyclicBarrierTaskScheduler中run()方法的逻辑：</p>
<p>我们首先根据batchTaskNumbers的数目来构建一个CyclicBarrier实例（实际代码里记得提前检查一下这个数量）， 这里的batchTaskNumbers也就是第一个参数parties的值，也就是说，只有当这些Batch Task执行完成之后，我们才会执行第二个参数提供的Runnable，所以不难猜到， 在CyclicBarrier的构造方法的第二个参数里，我们会执行所有的RealtimeTask。</p>
<p>有了CyclicBarrier的实例之后，我们需要通过某种方式告知这个CyclicBarrier都有哪些线程已经执行完成并到达了CyclicBarrier设定的边界（其实就是个计数）， 这个是通过CyclicBarrier的await()方法来完成的，所以也就有了接下来这段代码：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getBatchTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">        <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">                <span class="kw">new</span> <span class="fu">BatchTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">                <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">                    <span class="fu">getCyclicBarrier</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">                } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">                    e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">                } <span class="kw">catch</span> (<span class="bu">BrokenBarrierException</span> e) {</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">                    e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">                }</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">            }});</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    }</a></code></pre></div>
<p>在这里，我们也一共提交了batchTaskNumbers这些数量的Batch Task给Executor执行，在每一个提交的Runnable里， 当每一个BatchTask执行完毕之后，我们都会调用getCyclicBarrier().await()来通知CyclicBarrier“我做完了哈”， 当所有这些提交的Task都执行完毕之后，CyclicBarrier就会数一数然后跟batchTaskNumbers对比一下， “哦，都做完了哈，那我让通过构造方法第二个参数Runnable开始跑了哈”</p>
<p>咋样？到这里，我们的目标算是基本达成了吧？不过，同样是这个目标，也同样是使用CyclicBarrier，我们还可以使用CyclicBarrier的另一个构造方法来达成。 看官上眼啦！</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">        <span class="co">// pre-validate on states of current object</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">        </a>
<a class="sourceLine" id="cb5-4" data-line-number="4">        cyclicBarrier = <span class="kw">new</span> <span class="bu">CyclicBarrier</span>(<span class="fu">getBatchTaskNumbers</span>()+<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">        </a>
<a class="sourceLine" id="cb5-6" data-line-number="6">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getBatchTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">        {</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">                    <span class="kw">new</span> <span class="fu">BatchTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">                    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">                        <span class="fu">getCyclicBarrier</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">                    } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">                        e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">                    } <span class="kw">catch</span> (<span class="bu">BrokenBarrierException</span> e) {</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">                        e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">                    }</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">                }});</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">        }</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">        </a>
<a class="sourceLine" id="cb5-21" data-line-number="21">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">            cyclicBarrier.<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">        } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">            <span class="co">// process exception as per your needs</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">        } <span class="kw">catch</span> (<span class="bu">BrokenBarrierException</span> e) {</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">            <span class="co">// process exception as per your needs</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb5-29" data-line-number="29">        }</a>
<a class="sourceLine" id="cb5-30" data-line-number="30">        </a>
<a class="sourceLine" id="cb5-31" data-line-number="31">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getRealtimeTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb5-32" data-line-number="32">        {</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="fu">RealtimeTask</span>());</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">        }</a>
<a class="sourceLine" id="cb5-35" data-line-number="35">    }</a></code></pre></div>
<p>我们只看run()方法这部分，现在，我们使用只有一个参数的CyclicBarrier构造函数来构造CyclicBarrier实例， 但是，这回传入的parties数量则是在原来batchTaskNumbers的基础上加1， 当提交了所有batchTaskNumbers数量的Batch Task执行之后， 我们在当前线程调用了同一个CyclicBarrier实例的await()方法，凑上这个，正好就是当初构造CyclicBarrier时候传入的parties的数量。 所以，一样的效果，当这个CyclicBarrier被成功突破之后，当前线程中await()后面的提交并执行Realtime Task的逻辑才会执行。</p>
<p>关于CyclicBarrier我们就先“广播”到这里，下面是CountDownLatch上场时间…</p>
<h1 id="countdownlatch切这有啥我也行"><span class="header-section-number">2</span> CountDownLatch:切，这有啥，我也行！</h1>
<p>CountDownLatch，问其名，就知道它干啥的，不就个计数门闩嘛，呵呵，more or less， 这个CountDownLatch吧，跟CyclicBarrier差不多啦， 也是接收个计数，然后在某个线程里面await()住，也就是闩住这个线程的执行，之后，其他线程就可以通过countDown()来减少计数，当计数减少为0 的时候， 被闩住的那个线程就会被放行啦。</p>
<p>拿到我们假设的那个问题场景下来说，就是，我先通过CountDownLatch的await()暂停一下，让所有batchTaskNumbers数量的Batch Task都执行完， 然后采取执行RealtimeTask，不过，为了能够让CountDownLatch的await()不会一直暂停在那里不动，我们会在每一个Batch Task执行完成华，减少CountDownLatch的计数， 用代码说话就是：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CountDownLatchTaskScheduler <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="kw">private</span> <span class="bu">CountDownLatch</span> latch;</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="kw">private</span> <span class="dt">int</span>            batchTaskNumbers;</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="kw">private</span> <span class="dt">int</span>            realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    <span class="co">// you can set an ExecutorService extenally</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="kw">private</span> <span class="bu">ExecutorService</span> executor = <span class="bu">Executors</span>.<span class="fu">newFixedThreadPool</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">        <span class="co">// pre-validate on states of current object</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">        latch = <span class="kw">new</span> <span class="bu">CountDownLatch</span>(<span class="fu">getBatchTaskNumbers</span>());</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">        </a>
<a class="sourceLine" id="cb6-14" data-line-number="14">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getBatchTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">        {</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">                    <span class="kw">new</span> <span class="fu">BatchTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">                    </a>
<a class="sourceLine" id="cb6-20" data-line-number="20">                    <span class="fu">getLatch</span>().<span class="fu">countDown</span>();</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">                }});</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">        }</a>
<a class="sourceLine" id="cb6-23" data-line-number="23">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb6-24" data-line-number="24">            <span class="fu">getLatch</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">        } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">            <span class="co">// process exception as per your needs</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">        }</a>
<a class="sourceLine" id="cb6-29" data-line-number="29">        </a>
<a class="sourceLine" id="cb6-30" data-line-number="30">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getRealtimeTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">        {</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="fu">RealtimeTask</span>());</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">        }</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">        </a>
<a class="sourceLine" id="cb6-35" data-line-number="35">    }</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">    </a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">shutdown</span>()</a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    {</a>
<a class="sourceLine" id="cb6-39" data-line-number="39">        <span class="kw">if</span>(<span class="fu">getExecutor</span>() != <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb6-40" data-line-number="40">        {</a>
<a class="sourceLine" id="cb6-41" data-line-number="41">            <span class="fu">getExecutor</span>().<span class="fu">shutdown</span>();</a>
<a class="sourceLine" id="cb6-42" data-line-number="42">            <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb6-43" data-line-number="43">                <span class="fu">getExecutor</span>().<span class="fu">awaitTermination</span>(<span class="bu">Integer</span>.<span class="fu">MAX_VALUE</span>, <span class="bu">TimeUnit</span>.<span class="fu">SECONDS</span>);</a>
<a class="sourceLine" id="cb6-44" data-line-number="44">            } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">                e.<span class="fu">printStackTrace</span>(); <span class="co">// process exception as per your need</span></a>
<a class="sourceLine" id="cb6-46" data-line-number="46">            }</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">        }</a>
<a class="sourceLine" id="cb6-48" data-line-number="48">    }</a>
<a class="sourceLine" id="cb6-49" data-line-number="49"></a>
<a class="sourceLine" id="cb6-50" data-line-number="50">    <span class="kw">public</span> <span class="bu">CountDownLatch</span> <span class="fu">getLatch</span>() {</a>
<a class="sourceLine" id="cb6-51" data-line-number="51">        <span class="kw">return</span> latch;</a>
<a class="sourceLine" id="cb6-52" data-line-number="52">    }</a>
<a class="sourceLine" id="cb6-53" data-line-number="53"></a>
<a class="sourceLine" id="cb6-54" data-line-number="54">    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getBatchTaskNumbers</span>() {</a>
<a class="sourceLine" id="cb6-55" data-line-number="55">        <span class="kw">return</span> batchTaskNumbers;</a>
<a class="sourceLine" id="cb6-56" data-line-number="56">    }</a>
<a class="sourceLine" id="cb6-57" data-line-number="57"></a>
<a class="sourceLine" id="cb6-58" data-line-number="58">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setBatchTaskNumbers</span>(<span class="dt">int</span> batchTaskNumbers) {</a>
<a class="sourceLine" id="cb6-59" data-line-number="59">        <span class="kw">this</span>.<span class="fu">batchTaskNumbers</span> = batchTaskNumbers;</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">    }</a>
<a class="sourceLine" id="cb6-61" data-line-number="61"></a>
<a class="sourceLine" id="cb6-62" data-line-number="62">    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getRealtimeTaskNumbers</span>() {</a>
<a class="sourceLine" id="cb6-63" data-line-number="63">        <span class="kw">return</span> realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">    }</a>
<a class="sourceLine" id="cb6-65" data-line-number="65"></a>
<a class="sourceLine" id="cb6-66" data-line-number="66">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setRealtimeTaskNumbers</span>(<span class="dt">int</span> realtimeTaskNumbers) {</a>
<a class="sourceLine" id="cb6-67" data-line-number="67">        <span class="kw">this</span>.<span class="fu">realtimeTaskNumbers</span> = realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb6-68" data-line-number="68">    }</a>
<a class="sourceLine" id="cb6-69" data-line-number="69"></a>
<a class="sourceLine" id="cb6-70" data-line-number="70">    <span class="kw">public</span> <span class="bu">ExecutorService</span> <span class="fu">getExecutor</span>() {</a>
<a class="sourceLine" id="cb6-71" data-line-number="71">        <span class="kw">return</span> executor;</a>
<a class="sourceLine" id="cb6-72" data-line-number="72">    }</a>
<a class="sourceLine" id="cb6-73" data-line-number="73"></a>
<a class="sourceLine" id="cb6-74" data-line-number="74">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setExecutor</span>(<span class="bu">ExecutorService</span> executor) {</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">        <span class="kw">this</span>.<span class="fu">executor</span> = executor;</a>
<a class="sourceLine" id="cb6-76" data-line-number="76">    }</a>
<a class="sourceLine" id="cb6-77" data-line-number="77">    </a>
<a class="sourceLine" id="cb6-78" data-line-number="78">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args)</a>
<a class="sourceLine" id="cb6-79" data-line-number="79">    {</a>
<a class="sourceLine" id="cb6-80" data-line-number="80">        CountDownLatchTaskScheduler taskScheduler = <span class="kw">new</span> <span class="fu">CountDownLatchTaskScheduler</span>();</a>
<a class="sourceLine" id="cb6-81" data-line-number="81">        taskScheduler.<span class="fu">setBatchTaskNumbers</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb6-82" data-line-number="82">        taskScheduler.<span class="fu">setRealtimeTaskNumbers</span>(<span class="dv">15</span>);</a>
<a class="sourceLine" id="cb6-83" data-line-number="83">        </a>
<a class="sourceLine" id="cb6-84" data-line-number="84">        <span class="kw">try</span></a>
<a class="sourceLine" id="cb6-85" data-line-number="85">        {</a>
<a class="sourceLine" id="cb6-86" data-line-number="86">            taskScheduler.<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb6-87" data-line-number="87">        }</a>
<a class="sourceLine" id="cb6-88" data-line-number="88">        <span class="kw">finally</span></a>
<a class="sourceLine" id="cb6-89" data-line-number="89">        {</a>
<a class="sourceLine" id="cb6-90" data-line-number="90">            taskScheduler.<span class="fu">shutdown</span>();</a>
<a class="sourceLine" id="cb6-91" data-line-number="91">        }</a>
<a class="sourceLine" id="cb6-92" data-line-number="92">    }</a>
<a class="sourceLine" id="cb6-93" data-line-number="93">}</a></code></pre></div>
<p>我们根据batchTaskNumbers的数量构建了一个CountDownLatch，然后提交Batch Task执行，之后，通过CountDownLatch的await()方法等待所有这些Batch Task执行完毕，然后再接着执行后面的逻辑。 至于await()如何知道什么才不await()了，当然就是当每一个Batch Task执行之后都countDown()之后啦。</p>
<p>另外，我们还可以换一个角度来看待或者说使用CountDownLatch，当然，这个跟我们的假设场景并没啥关系了，纯粹是CountDownLatch相关的内容。 我们上面是在主要的执行线程里面await()，然后在其他执行线程里面countDown;反过来，我们也可以在主要的执行线程里面countDown，然后在执行线程里面await()， 这个时候，那些await的执行线程就好比一匹匹急欲冲出栅栏的赛马，当主要线程里countDown一声枪响之后，这些await的执行线程才会开始执行。</p>
<p>比如，我们为新的CountDownLatchTaskScheduler再添加一个CountDownLatch，这个CountDownLatch将 负责控制RealtimeTask，只有CountDownLatch的计数减少到0之后，这些RealtimeTask才可以才是执行， 这实际上又做了一遍“代码清单 3”里那个CountDownLatch的工作，对我们当前假设场景没啥太大意义，不过，两个对比这看,或许也还可以:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CountDownLatchTaskScheduler <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="kw">private</span> <span class="bu">CountDownLatch</span> latch;</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    </a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="kw">private</span> <span class="bu">CountDownLatch</span> signalLatch = <span class="kw">new</span> <span class="bu">CountDownLatch</span>(<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="kw">private</span> <span class="dt">int</span>            batchTaskNumbers;</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    <span class="kw">private</span> <span class="dt">int</span>            realtimeTaskNumbers;</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">    </a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    <span class="co">// you can set an ExecutorService extenally</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    <span class="kw">private</span> <span class="bu">ExecutorService</span> executor = <span class="bu">Executors</span>.<span class="fu">newFixedThreadPool</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">        <span class="co">// pre-validate on states of current object</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">        latch = <span class="kw">new</span> <span class="bu">CountDownLatch</span>(<span class="fu">getBatchTaskNumbers</span>());</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">        </a>
<a class="sourceLine" id="cb7-17" data-line-number="17">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getBatchTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        {</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">                    <span class="kw">new</span> <span class="fu">BatchTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">                    </a>
<a class="sourceLine" id="cb7-23" data-line-number="23">                    <span class="fu">getLatch</span>().<span class="fu">countDown</span>();</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">                }});</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">        }</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">        </a>
<a class="sourceLine" id="cb7-27" data-line-number="27">        <span class="kw">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;<span class="fu">getRealtimeTaskNumbers</span>();i++)</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">        {</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">            <span class="fu">getExecutor</span>().<span class="fu">execute</span>(<span class="kw">new</span> <span class="bu">Runnable</span>(){</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">                    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">                        <span class="fu">getSignalLatch</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">                    } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">                        <span class="co">// process exception as per your needs</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36">                    }</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">                    </a>
<a class="sourceLine" id="cb7-38" data-line-number="38">                    <span class="kw">new</span> <span class="fu">RealtimeTask</span>().<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">                }</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">                </a>
<a class="sourceLine" id="cb7-41" data-line-number="41">            });</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">        }</a>
<a class="sourceLine" id="cb7-43" data-line-number="43">        </a>
<a class="sourceLine" id="cb7-44" data-line-number="44">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb7-45" data-line-number="45">            <span class="fu">getLatch</span>().<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb7-46" data-line-number="46">        } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">            <span class="co">// process exception as per your needs</span></a>
<a class="sourceLine" id="cb7-48" data-line-number="48">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb7-49" data-line-number="49">        }</a>
<a class="sourceLine" id="cb7-50" data-line-number="50">        </a>
<a class="sourceLine" id="cb7-51" data-line-number="51">        <span class="fu">getSignalLatch</span>().<span class="fu">countDown</span>();</a>
<a class="sourceLine" id="cb7-52" data-line-number="52">    }</a>
<a class="sourceLine" id="cb7-53" data-line-number="53">    </a>
<a class="sourceLine" id="cb7-54" data-line-number="54">    ...</a>
<a class="sourceLine" id="cb7-55" data-line-number="55">}</a></code></pre></div>
<p>你可以看到，即使我们很早就提交了RealtimeTask给Executor执行，但只有当countDown()号令发出之后，这些RealtimeTask才会真正开始执行，此前，它们必须等！</p>
<p>针对CountDownLatch就说这些。</p>
<h1 id="最后要说的话"><span class="header-section-number">3</span> 最后要说的话</h1>
<p>现在回过头来说BatchTask和RealtimeTask定义过于简单的问题，实际上，这样定义这两个类是想让各位看官只关注每一个Task类型本该 关心的事情， 至于这些Task如何协调调度执行，则剥离到更外层去； 另一个原因就是，我们现在看到的跟CountDownLatch和CyclicBarrier有关的Samples代码都是直接传入一个 CountDownLatch和CyclicBarrier的共享实例给每一个Task, 例如：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BatchTask <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">    <span class="kw">private</span> <span class="bu">CyclicBarrier</span> cyclicBarrier;</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    </a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    <span class="kw">public</span> <span class="fu">BatchTask</span>(<span class="bu">CyclicBarrier</span> cyclicBarrier)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">        <span class="kw">this</span>.<span class="fu">cyclicBarrier</span> = cyclicBarrier;</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    }</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">    </a>
<a class="sourceLine" id="cb8-10" data-line-number="10">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">        <span class="co">// TODO your batch task logic</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">        </a>
<a class="sourceLine" id="cb8-13" data-line-number="13">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">            cyclicBarrier.<span class="fu">await</span>();</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">        } <span class="kw">catch</span> (<span class="bu">InterruptedException</span> e) {</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">            <span class="co">// TODO Auto-generated catch block</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">        } <span class="kw">catch</span> (<span class="bu">BrokenBarrierException</span> e) {</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">            <span class="co">// TODO Auto-generated catch block</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">            e.<span class="fu">printStackTrace</span>();</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">        }</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">    }</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">}</a></code></pre></div>
<p>那么，当我转向讲解CountDownLatch方式的时候，就得再将这个BatchTask的定义改成如下的样子：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> BatchTask <span class="kw">implements</span> <span class="bu">Runnable</span> {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">    <span class="kw">private</span> <span class="bu">CountDownLatch</span> latch;</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    </a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    <span class="kw">public</span> <span class="fu">BatchTask</span>(<span class="bu">CountDownLatch</span> latch)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">        <span class="kw">this</span>.<span class="fu">latch</span> = latch;</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">    }</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">        <span class="co">// TODO your batch task logic</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">        latch.<span class="fu">countDown</span>();</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">}</a></code></pre></div>
<p>对于RealtimeTask也是一个道理，你写代码的时候，决定用啥了之后当然不太会变，但是，我要是也这么干，来回折腾还不得烦死阿，呵呵， 而且，把这些东西剥离或者说外部化到这些Task定义之外，好像要更“干净” <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> ，也更好理解一下吧？！</p>
<p>OK， 打完收工，睡觉…</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>知道大连话“干净”咋说不？呵呵<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>

    </article>

  </body>
</html>
